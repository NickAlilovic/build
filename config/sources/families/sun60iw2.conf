#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

declare -g LINUXFAMILY="sun60iw2"
declare -g ARCH="arm64"
declare -g ATF_COMPILE='no'
declare -g DEB_VENDOR_BLOB="${SRC}/packages/blobs/sunxi/sun60iw2/u-boot-aw2501_2018.07-10_all.deb"

function build_custom_uboot() {
    display_alert "Using vendor U-Boot binary (repackage)" "${BOARD}" "info"

    # uboottempdir and uboot_name are provided by the caller (compile_uboot)
    [[ -z "${uboottempdir:-}" ]] && exit_with_error "uboottempdir is not set by caller"
    [[ -z "${uboot_name:-}" ]] && exit_with_error "uboot_name is not set by caller"

    local vendortmp
    vendortmp=$(mktemp -d)
    ( cd "${vendortmp}" && dpkg-deb -x "${DEB_VENDOR_BLOB}" . ) || {
        rm -rf "${vendortmp}"
        exit_with_error "Failed to extract vendor .deb: ${DEB_VENDOR_BLOB}"
    }

    mkdir -p "${uboottempdir}/usr/lib/${uboot_name}"

    local srcdir=""
    if [[ -d "${vendortmp}/usr/lib/u-boot/${BOARD}" ]]; then
        srcdir="${vendortmp}/usr/lib/u-boot/${BOARD}"
    fi

    if [[ -n "${srcdir}" ]]; then
        # copy common blob types into packaging area (handle bin and fex separately to avoid shell glob pitfalls)
        cp -v "${srcdir}"/*.bin "${uboottempdir}/usr/lib/${uboot_name}/" 2>/dev/null || true
        cp -v "${srcdir}"/*.fex "${uboottempdir}/usr/lib/${uboot_name}/" 2>/dev/null || true
    else
        display_alert "Vendor package layout not found; skipping" "${BOARD}" "warn"
    fi

    rm -rf "${vendortmp}"

    declare -g EXTENSION_BUILT_UBOOT="yes"

    return 0
}

case "${BRANCH}" in

    legacy)
        declare -g KERNEL_MAJOR_MINOR="5.15"
        declare -g KERNELSOURCE="${GITHUB_SOURCE}/radxa/kernel.git"
        declare -g KERNELBRANCH="branch:allwinner-aiot-linux-5.15"
        declare -g KERNELPATCHDIR="archive/sunxi-${KERNEL_MAJOR_MINOR}"
        declare -g LINUXCONFIG="linux-sun60i-${BRANCH}"
        declare -g ALLWINNER_BSP_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-bsp"
        declare -g BSPBRANCH="branch:cubie-aiot-v1.4.6"
        ;;

esac

function kernel_copy_extra_sources__radxa_allwinner_bsp() {
    display_alert "$BOARD" "Copying Radxa Allwinner BSP (Board Support Package)" "info"

    allwinner_bsp_git_bare_tree="${SRC}/cache/git-bare/allwinner-bsp"
    declare allwinner_bsp_git_bare_tree_done_marker="${allwinner_bsp_git_bare_tree}/.git/armbian-bare-tree-done"

    if [[ ! -d "${allwinner_bsp_git_bare_tree}" || ! -f "${allwinner_bsp_git_bare_tree_done_marker}" ]]; then
        if [[ -d "${allwinner_bsp_git_bare_tree}" ]]; then
            rm -rf "${allwinner_bsp_git_bare_tree}"
        fi

        run_host_command_logged git clone --tags --no-checkout \
            "${ALLWINNER_BSP_SOURCE}" "${allwinner_bsp_git_bare_tree}"

        touch "${allwinner_bsp_git_bare_tree_done_marker}"
    fi

    git_ensure_safe_directory "${allwinner_bsp_git_bare_tree}"

    GIT_FIXED_WORKDIR="${LINUXSOURCEDIR}/bsp" \
        GIT_BARE_REPO_FOR_WORKTREE="${allwinner_bsp_git_bare_tree}" \
        GIT_BARE_REPO_INITIAL_BRANCH="${BSPBRANCH#*:}" \
        fetch_from_repo "${ALLWINNER_BSP_SOURCE}" "allwinner_bsp:${KERNEL_MAJOR_MINOR}" "${BSPBRANCH}" "yes"
}

write_uboot_platform() {
	local SCRIPT_DIR="$1"
	local DEVICE="$2"

	dd conv=notrunc,fsync if="$SCRIPT_DIR/boot0_sdcard.bin" of="$DEVICE" bs=512 seek=256
	dd conv=notrunc,fsync if="$SCRIPT_DIR/boot0_ufs.bin" of="$DEVICE" bs=512 seek=2064
	dd conv=notrunc,fsync if="$SCRIPT_DIR/boot_package.fex" of="$DEVICE" bs=512 seek=24576
 	sync "${DEVICE}"
}
